name: Raspberry Pi Kernel Tag Update

on:
  schedule:
    - cron: '17 */6 * * *' # Every 6 hours at minute 17
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check Raspberry Pi kernel tags and open PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine latest Raspberry Pi stable kernel tag and SHA
        id: latest
        uses: actions/github-script@v7
        with:
          script: |
            const owner = 'raspberrypi';
            const repo = 'linux';
            const pattern = /^stable_\d{8}$/;
            let page = 1;
            let latestTag = null;
            let latestSha = null;
            // Paginate until we find a matching tag or run out
            while (!latestTag) {
              const { data: tags } = await github.rest.repos.listTags({ owner, repo, per_page: 100, page });
              if (!tags || tags.length === 0) break;
              const match = tags.find(t => pattern.test(t.name));
              if (match) {
                latestTag = match.name;
                latestSha = match.commit?.sha || null;
                break;
              }
              page++;
              if (page > 10) break; // safety cap
            }
            if (!latestTag || !latestSha) {
              core.setFailed('Could not resolve latest Raspberry Pi kernel tag');
              return;
            }
            core.info(`Latest upstream tag: ${latestTag} (${latestSha})`);
            core.setOutput('tag', latestTag);
            core.setOutput('sha', latestSha);

      - name: Parse current kernel SHA from raspberrypi4-64-rauc_defconfig
        id: current
        shell: bash
        run: |
          set -euo pipefail
          DEFCONFIG="buildroot-external/configs/raspberrypi4-64-rauc_defconfig"
          if [[ ! -f "${DEFCONFIG}" ]]; then
            echo "Defconfig not found: ${DEFCONFIG}" >&2
            exit 1
          fi
          # Extract the SHA from the BR2_LINUX_KERNEL_CUSTOM_TARBALL_LOCATION line
          # Looks like: $(call github,raspberrypi,linux,<sha>)/linux-<sha>.tar.gz
          CURR_SHA=$(grep -Eo '\\(call github,raspberrypi,linux,[a-f0-9]{7,40}\\)' "${DEFCONFIG}" | sed -E 's/.*linux,([a-f0-9]{7,40}).*/\1/' || true)
          echo "Current SHA in defconfig: ${CURR_SHA:-<none>}"
          echo "sha=${CURR_SHA}" >> "$GITHUB_OUTPUT"

      - name: Decide whether an update is needed
        id: decide
        run: |
          set -euo pipefail
          LATEST_SHA="${{ steps.latest.outputs.sha }}"
          CURRENT_SHA="${{ steps.current.outputs.sha }}"
          if [[ -n "${CURRENT_SHA}" && "${LATEST_SHA}" == "${CURRENT_SHA}" ]]; then
            echo "no_update=true" >> "$GITHUB_OUTPUT"
            echo "No update needed."
          else
            echo "no_update=false" >> "$GITHUB_OUTPUT"
            echo "Update needed: ${CURRENT_SHA:-<none>} -> ${LATEST_SHA}"
          fi

      - name: Create update branch, update raspberrypi4-64 defconfig, commit, and push
        if: steps.decide.outputs.no_update == 'false'
        env:
          LATEST_TAG: ${{ steps.latest.outputs.tag }}
          LATEST_SHA: ${{ steps.latest.outputs.sha }}
        run: |
          set -euo pipefail
          BRANCH="update/rpi-kernel/${LATEST_TAG}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Create a branch from default branch
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          # Checkout from remote default branch if available; fallback to local branch name
          if git show-ref --verify --quiet "refs/remotes/origin/${DEFAULT_BRANCH}"; then
            git checkout -b "${BRANCH}" "origin/${DEFAULT_BRANCH}"
          else
            git checkout -b "${BRANCH}" "${DEFAULT_BRANCH}"
          fi

          # Update only the raspberrypi4-64 RAUC defconfig to point to the new kernel tarball (commit SHA)
          DEFCONFIG="buildroot-external/configs/raspberrypi4-64-rauc_defconfig"
          echo "Updating tarball URL in ${DEFCONFIG} to SHA ${LATEST_SHA}"
          sed -i -E 's#(\(call github,raspberrypi,linux,)[a-f0-9]{7,40}#\1'"${LATEST_SHA}"'#' "$DEFCONFIG"
          sed -i -E 's#(linux-)[a-f0-9]{7,40}(\.tar\.gz)#\1'"${LATEST_SHA}"'\2#' "$DEFCONFIG"

          git add "$DEFCONFIG"
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "raspberrypi4-64: track stable kernel ${LATEST_TAG} (${LATEST_SHA})"
          fi
          git push --set-upstream origin "${BRANCH}"

      - name: Open or update pull request
        if: steps.decide.outputs.no_update == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.latest.outputs.tag }}';
            const sha = '${{ steps.latest.outputs.sha }}';
            const branch = `update/rpi-kernel/${tag}`;
            const { data: repo } = await github.rest.repos.get(context.repo);
            const base = repo.default_branch;

            // Check for an existing open PR from the same branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`,
              base,
              per_page: 1,
            });
            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Follow Raspberry Pi stable kernel ${tag}`;
            const body = [
              `Automated update to follow upstream Raspberry Pi stable kernel`,
              `- Upstream repo: raspberrypi/linux`,
              `- New tag: ${tag}`,
              `- Commit: ${sha}`,
              '',
              'If additional steps are needed (e.g., bumping references in build scripts), commit them to this branch.'
            ].join("\n");

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branch,
              base,
              body,
              maintainer_can_modify: true,
            });
            core.info(`Created PR: ${pr.html_url}`);
