name: Raspberry Pi Kernel Tag Update

on:
  schedule:
    - cron: '17 */6 * * *' # Every 6 hours at minute 17
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check Raspberry Pi kernel tags and open PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine latest Raspberry Pi kernel tag
        id: latest
        uses: actions/github-script@v7
        with:
          script: |
            const owner = 'raspberrypi';
            const repo = 'linux';
            const pattern = /^raspberrypi-kernel[_-]/;
            let page = 1;
            let latestTag = null;
            // Paginate until we find a matching tag or run out
            while (!latestTag) {
              const { data: tags } = await github.rest.repos.listTags({ owner, repo, per_page: 100, page });
              if (!tags || tags.length === 0) break;
              const match = tags.find(t => pattern.test(t.name));
              if (match) {
                latestTag = match.name;
                break;
              }
              page++;
              if (page > 10) break; // safety cap
            }
            if (!latestTag) {
              core.setFailed('Could not resolve latest Raspberry Pi kernel tag');
              return;
            }
            core.info(`Latest upstream tag: ${latestTag}`);
            core.setOutput('tag', latestTag);

      - name: Read currently tracked tag in this repo (if any)
        id: current
        shell: bash
        run: |
          set -euo pipefail
          TRACK_FILE=".github/raspberrypi_kernel_tag.txt"
          if [[ -f "${TRACK_FILE}" ]]; then
            CURR_TAG=$(cat "${TRACK_FILE}" | tr -d '\n' || true)
          else
            CURR_TAG=""
          fi
          echo "Current tracked tag: ${CURR_TAG:-<none>}"
          echo "tag=${CURR_TAG}" >> "$GITHUB_OUTPUT"

      - name: Decide whether an update is needed
        id: decide
        run: |
          set -euo pipefail
          LATEST="${{ steps.latest.outputs.tag }}"
          CURRENT="${{ steps.current.outputs.tag }}"
          if [[ "${LATEST}" == "${CURRENT}" ]]; then
            echo "no_update=true" >> "$GITHUB_OUTPUT"
            echo "No update needed."
          else
            echo "no_update=false" >> "$GITHUB_OUTPUT"
            echo "Update needed: ${CURRENT:-<none>} -> ${LATEST}"
          fi

      - name: Create update branch, commit, and push
        if: steps.decide.outputs.no_update == 'false'
        env:
          LATEST_TAG: ${{ steps.latest.outputs.tag }}
        run: |
          set -euo pipefail
          BRANCH="update/rpi-kernel/${LATEST_TAG}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Create a branch from default branch
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          git checkout -b "${BRANCH}" "origin/${DEFAULT_BRANCH}"

          # Write the tracked tag file and a changelog note
          mkdir -p .github
          echo "${LATEST_TAG}" > .github/raspberrypi_kernel_tag.txt

          # Optionally keep a history file
          CHANGELOG_FILE=.github/raspberrypi_kernel_history.md
          NOW=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          {
            echo "- ${NOW} Updated to ${LATEST_TAG}"
          } >> "${CHANGELOG_FILE}"

          git add .github/raspberrypi_kernel_tag.txt "${CHANGELOG_FILE}"
          git commit -m "Raspberry Pi kernel: track ${LATEST_TAG}"
          git push --set-upstream origin "${BRANCH}"

      - name: Open or update pull request
        if: steps.decide.outputs.no_update == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = `update/rpi-kernel/${{ steps.latest.outputs.tag }}`;
            const { data: repo } = await github.rest.repos.get(context.repo);
            const base = repo.default_branch;

            // Check for an existing open PR from the same branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`,
              base,
              per_page: 1,
            });
            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Update Raspberry Pi kernel tag to ${{ steps.latest.outputs.tag }}`;
            const body = [
              `Automated update to follow upstream Raspberry Pi kernel tag`,
              `- Upstream repo: raspberrypi/linux`,
              `- New tag: ${{ steps.latest.outputs.tag }}`,
              '',
              'If additional steps are needed (e.g., bumping references in build scripts), commit them to this branch.'
            ].join("\n");

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branch,
              base,
              body,
              maintainer_can_modify: true,
            });
            core.info(`Created PR: ${pr.html_url}`);
